<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webhook Control Panel</title>
    <style>
        :root { --primary: #00d2ff; --bg: #0f172a; --card-bg: rgba(30, 41, 59, 0.7); }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: white; margin: 0; display: flex; height: 100vh; }
        
        .sidebar { width: 350px; background: rgba(0,0,0,0.4); padding: 20px; border-right: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .main { flex: 1; display: flex; justify-content: center; align-items: center; background: radial-gradient(circle, #1e293b 0%, #0f172a 100%); }
        
        .group { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
        label { font-size: 10px; text-transform: uppercase; color: #94a3b8; font-weight: bold; }
        input, select, textarea { background: var(--card-bg); border: 1px solid #334155; border-radius: 8px; color: white; padding: 10px; font-size: 13px; }
        
        /* Lista de Servidores e Canais */
        .selector-box { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 10px; max-height: 200px; overflow-y: auto; border: 1px solid #334155; }
        .item-list { padding: 8px; cursor: pointer; border-radius: 5px; font-size: 13px; transition: 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .item-list:hover { background: var(--primary); color: #000; }
        
        .card { background: rgba(255,255,255,0.03); backdrop-filter: blur(20px); padding: 35px; border-radius: 20px; width: 450px; border: 1px solid rgba(255,255,255,0.1); }
        .btn { cursor: pointer; border: none; border-radius: 8px; font-weight: bold; padding: 12px; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: #000; width: 100%; margin-top: 20px; font-size: 16px; }
        .btn-load { background: #5865F2; color: white; font-size: 11px; }

        #status { margin-top: 15px; text-align: center; font-size: 12px; font-weight: bold; }
        .loader { color: var(--primary); font-size: 10px; }
    </style>
</head>
<body>

<div class="sidebar">
    <h3>ü§ñ Bot Manager</h3>
    
    <div class="group">
        <label>Token do Bot</label>
        <input type="password" id="botToken" placeholder="Insira o Token...">
        <button class="btn btn-load" onclick="carregarServidores()" style="margin-top:5px">üîÑ CARREGAR SERVIDORES</button>
    </div>

    <div class="group">
        <label>1. Selecione o Servidor</label>
        <div id="serverList" class="selector-box">
            <div class="item-list" style="opacity:0.5">Aguardando Token...</div>
        </div>
    </div>

    <div class="group">
        <label>2. Selecione o Canal</label>
        <div id="channelList" class="selector-box">
            <div class="item-list" style="opacity:0.5">Selecione um servidor primeiro...</div>
        </div>
    </div>

    <div class="group">
        <label>URL do Webhook Gerada</label>
        <input type="text" id="webUrl" readonly style="font-size: 9px; opacity: 0.7;">
    </div>
</div>

<div class="main">
    <div class="card">
        <h2 style="margin-top:0">Enviar Mensagem</h2>
        <div class="group">
            <label>Nome do Bot</label>
            <input type="text" id="botName" placeholder="Apelido do bot no envio">
        </div>
        <div class="group">
            <label>Mensagem</label>
            <textarea id="msgText" rows="5" placeholder="Digite aqui..."></textarea>
        </div>
        <div class="group">
            <label>Anexar Imagem</label>
            <input type="file" id="msgFile">
        </div>
        <button class="btn btn-primary" onclick="enviar()">DISPARAR</button>
        <div id="status"></div>
    </div>
</div>

<script>
    const apiBase = "https://discord.com/api/v10";

    // Busca Servidores que o Bot est√°
    async function carregarServidores() {
        const token = document.getElementById('botToken').value.trim();
        const serverList = document.getElementById('serverList');
        if(!token) return alert("Insira o Token!");

        serverList.innerHTML = "<div class='loader'>Buscando guildas...</div>";

        try {
            const res = await fetch(`${apiBase}/users/@me/guilds`, {
                headers: { "Authorization": `Bot ${token}` }
            });
            const guilds = await res.json();

            if(!res.ok) throw new Error(guilds.message);

            serverList.innerHTML = "";
            guilds.forEach(guild => {
                const div = document.createElement('div');
                div.className = 'item-list';
                div.innerText = guild.name;
                div.onclick = () => carregarCanais(guild.id, token);
                serverList.appendChild(div);
            });
        } catch(e) {
            serverList.innerHTML = "<div style='color:red'>Erro ao carregar servidores.</div>";
        }
    }

    // Busca Canais de Texto do Servidor Selecionado
    async function carregarCanais(guildId, token) {
        const channelList = document.getElementById('channelList');
        channelList.innerHTML = "<div class='loader'>Buscando canais...</div>";

        try {
            const res = await fetch(`${apiBase}/guilds/${guildId}/channels`, {
                headers: { "Authorization": `Bot ${token}` }
            });
            const channels = await res.json();

            // Filtra apenas canais de texto (type 0) ou an√∫ncios (type 5)
            const textChannels = channels.filter(c => c.type === 0 || c.type === 5);

            channelList.innerHTML = "";
            textChannels.forEach(chan => {
                const div = document.createElement('div');
                div.className = 'item-list';
                div.innerText = "# " + chan.name;
                div.onclick = () => vincularOuCriarWebhook(chan.id, token, chan.name);
                channelList.appendChild(div);
            });
        } catch(e) {
            channelList.innerHTML = "Erro ao carregar canais.";
        }
    }

    // Verifica se j√° tem Webhook ou cria um novo no canal clicado
    async function vincularOuCriarWebhook(channelId, token, channelName) {
        const status = document.getElementById('status');
        status.innerHTML = "‚è≥ Configurando Webhook...";

        try {
            // 1. Busca webhooks existentes no canal
            const res = await fetch(`${apiBase}/channels/${channelId}/webhooks`, {
                headers: { "Authorization": `Bot ${token}` }
            });
            const webhooks = await res.json();

            let myWebhook = webhooks.find(w => w.name.includes("Dash"));

            if(!myWebhook) {
                // 2. Cria um novo se n√£o existir
                const createRes = await fetch(`${apiBase}/channels/${channelId}/webhooks`, {
                    method: 'POST',
                    headers: { "Authorization": `Bot ${token}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ name: "Dash Webhook" })
                });
                myWebhook = await createRes.json();
            }

            if(myWebhook.url) {
                document.getElementById('webUrl').value = myWebhook.url;
                status.innerHTML = `‚úÖ Pronto para enviar em #${channelName}`;
            }
        } catch(e) {
            status.innerHTML = "‚ùå Erro ao criar Webhook. O Bot tem permiss√£o?";
        }
    }

    async function enviar() {
        const url = document.getElementById('webUrl').value;
        const text = document.getElementById('msgText').value;
        const name = document.getElementById('botName').value;
        const file = document.getElementById('msgFile').files[0];
        const status = document.getElementById('status');

        if(!url) return alert("Selecione um canal primeiro!");

        const formData = new FormData();
        formData.append('payload_json', JSON.stringify({ content: text, username: name || undefined }));
        if(file) formData.append('file', file);

        status.innerHTML = "üöÄ Enviando...";
        const res = await fetch(url, { method: 'POST', body: formData });
        if(res.ok) {
            status.innerHTML = "‚úÖ Mensagem enviada!";
            document.getElementById('msgText').value = "";
        } else {
            status.innerHTML = "‚ùå Erro ao enviar.";
        }
    }
</script>
</body>
</html>
