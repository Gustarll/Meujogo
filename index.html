<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDqYWTRKvmyjRM-to5raljV464Zvott4eM",
        authDomain: "whitermultiplayer.firebaseapp.com",
        databaseURL: "https://whitermultiplayer-default-rtdb.firebaseio.com",
        projectId: "whitermultiplayer",
        appId: "1:859405698218:web:44b4d4e1a96c937373cd3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const canvas = document.getElementById('jogo');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let player = { x: 200, y: 200, angulo: 0, cor: 'cyan', lastShot: 0, vivo: true };
    let inimigo = { x: -500, y: -500, angulo: 0, cor: 'red', vivo: true };
    let rastro = null;
    let teclas = {};
    let rodando = false;
    let meuId = ""; 
    let salaId = "";

    window.onkeydown = (e) => teclas[e.key.toLowerCase()] = true;
    window.onkeyup = (e) => teclas[e.key.toLowerCase()] = false;

    // Funções de Sala (Modo Online)
    window.criarSala = () => {
        salaId = Math.floor(100000 + Math.random() * 900000).toString();
        meuId = "p1";
        set(ref(db, 'salas/' + salaId), { p1: {x:200, y:200, a:0, v:true}, status: 'esperando' });
        document.getElementById('msg').innerText = "CÓDIGO: " + salaId;
        conectarFirebase();
    };

    window.entrarSala = () => {
        salaId = document.getElementById('inputCodigo').value;
        if(salaId.length === 6) {
            meuId = "p2";
            update(ref(db, 'salas/' + salaId), { p2: {x:600, y:200, a:0, v:true}, status: 'jogando' });
            conectarFirebase();
        }
    };

    function conectarFirebase() {
        onValue(ref(db, 'salas/' + salaId), (snap) => {
            const dados = snap.val();
            if(!dados) return;
            if(dados.status === 'jogando') {
                document.getElementById('menu').style.display = 'none';
                rodando = true;
            }
            // Sincroniza Inimigo
            let outro = meuId === "p1" ? dados.p2 : dados.p1;
            if(outro) {
                inimigo.x = outro.x;
                inimigo.y = outro.y;
                inimigo.angulo = outro.a;
                inimigo.vivo = outro.v;
            }
            // Verifica se você morreu (pelo dado do servidor)
            let eu = meuId === "p1" ? dados.p1 : dados.p2;
            if(eu && eu.v === false && player.vivo === true) {
                morrer();
            }
        });
    }

    function morrer() {
        player.vivo = false;
        setTimeout(() => {
            player.x = Math.random() * (canvas.width - 100) + 50;
            player.y = Math.random() * (canvas.height - 100) + 50;
            player.vivo = true;
            enviarDados();
        }, 1000); // 1 segundo para renascer
    }

    function enviarDados() {
        if(salaId) {
            update(ref(db, `salas/${salaId}/${meuId}`), { 
                x: player.x, y: player.y, a: player.angulo, v: player.vivo 
            });
        }
    }

    // Lógica do Tiro e Rastro
    window.onmousedown = () => {
        if(!rodando || !player.vivo) return;
        const agora = Date.now();
        if(agora - player.lastShot > 500) {
            player.lastShot = agora;
            
            // Define o rastro (ponto A ao ponto B)
            const alcance = 2000;
            const destinoX = player.x + Math.cos(player.angulo) * alcance;
            const destinoY = player.y + Math.sin(player.angulo) * alcance;
            
            rastro = { x1: player.x, y1: player.y, x2: destinoX, y2: destinoY, alpha: 1 };

            // Verifica colisão do tiro com o inimigo
            verificarAcerto(destinoX, destinoY);
        }
    };

    function verificarAcerto(tx, ty) {
        if(!inimigo.vivo) return;
        
        // Cálculo de distância entre a linha do tiro e o centro do inimigo
        const d = distLinhaPonto(player.x, player.y, tx, ty, inimigo.x, inimigo.y);
        
        if(d < 20) { // 20 é o raio do boneco
            const outroId = meuId === "p1" ? "p2" : "p1";
            update(ref(db, `salas/${salaId}/${outroId}`), { v: false });
        }
    }

    function distLinhaPonto(x1, y1, x2, y2, px, py) {
        const area = Math.abs((y2 - y1) * px - (x2 - x1) * py + x2 * y1 - y2 * x1);
        const tamLinha = Math.sqrt(Math.pow(y2 - y1, 2) + Math.pow(x2 - x1, 2));
        return area / tamLinha;
    }

    function loop() {
        if(rodando && player.vivo) {
            if(teclas['w']) player.y -= 5;
            if(teclas['s']) player.y += 5;
            if(teclas['a']) player.x -= 5;
            if(teclas['d']) player.x += 5;

            window.onmousemove = (e) => {
                player.angulo = Math.atan2(e.clientY - player.y, e.clientX - player.x);
            };
            enviarDados();
        }

        // Desenho
        ctx.fillStyle = "#111";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Desenha rastro da bala (desaparece gradualmente)
        if(rastro && rastro.alpha > 0) {
            ctx.strokeStyle = `rgba(255, 255, 255, ${rastro.alpha})`;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(rastro.x1, rastro.y1);
            ctx.lineTo(rastro.x2, rastro.y2);
            ctx.stroke();
            rastro.alpha -= 0.05; // Velocidade do sumiço do rastro
        }

        if(inimigo.vivo) desenharBoneco(inimigo.x, inimigo.y, inimigo.angulo, "red");
        if(player.vivo) desenharBoneco(player.x, player.y, player.angulo, "cyan");

        requestAnimationFrame(loop);
    }

    function desenharBoneco(x, y, ang, cor) {
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(ang);
        ctx.fillStyle = "#fff";
        ctx.fillRect(15, -3, 30, 6); // Arma
        ctx.restore();
        ctx.beginPath();
        ctx.arc(x, y, 20, 0, Math.PI*2);
        ctx.fillStyle = cor;
        ctx.fill();
    }
    loop();
</script>
