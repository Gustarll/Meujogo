<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAME SHOT - Online</title>
    <style>
        body { margin: 0; background: #111; color: white; font-family: sans-serif; overflow: hidden; }
        #menu { position: absolute; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); z-index: 10; }
        canvas { display: block; background: #1a1a1a; }
        .btn { padding: 15px 30px; margin: 10px; cursor: pointer; background: #e74c3c; border: none; color: white; font-weight: bold; border-radius: 5px; font-size: 16px; }
        .btn:hover { background: #ff5e4d; }
        input { padding: 10px; font-size: 1.2rem; text-align: center; width: 150px; border-radius: 5px; border: none; margin-bottom: 10px; }
        #msg { color: #f1c40f; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

<div id="menu">
    <h1>GAME SHOT</h1>
    <button class="btn" onclick="window.iniciarTreino()">MODO TREINAMENTO</button>
    <div style="height: 1px; width: 200px; background: #444; margin: 20px;"></div>
    <h3>1v1 ONLINE</h3>
    <button class="btn" style="background: #27ae60;" onclick="window.criarSala()">CRIAR CÓDIGO</button>
    <div style="display: flex; flex-direction: column; align-items: center;">
        <input type="text" id="inputCodigo" placeholder="000000" maxlength="6">
        <button class="btn" style="background: #2980b9;" onclick="window.entrarSala()">ENTRAR</button>
    </div>
    <p id="msg"></p>
</div>

<canvas id="jogo"></canvas>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Configurações do seu Firebase (conforme sua imagem)
    const firebaseConfig = {
        apiKey: "AIzaSyDqYWTRKvmyjRM-to5raljV464Zvott4eM",
        authDomain: "whitermultiplayer.firebaseapp.com",
        databaseURL: "https://whitermultiplayer-default-rtdb.firebaseio.com",
        projectId: "whitermultiplayer",
        appId: "1:859405698218:web:44b4d4e1a96c937373cd3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const canvas = document.getElementById('jogo');
    const ctx = canvas.getContext('2d');
    
    function ajustarTela() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', ajustarTela);
    ajustarTela();

    // Estado do Jogo
    let p = { x: 300, y: 300, ang: 0, cor: 'cyan', vivo: true, reload: 0 };
    let inimigo = { x: -500, y: -500, ang: 0, cor: 'red', vivo: true };
    let rastro = null;
    let teclas = {};
    let rodando = false;
    let meuId = "", salaId = "";

    // Controles
    window.addEventListener('keydown', (e) => teclas[e.key.toLowerCase()] = true);
    window.addEventListener('keyup', (e) => teclas[e.key.toLowerCase()] = false);
    window.addEventListener('mousemove', (e) => {
        if (rodando && p.vivo) p.ang = Math.atan2(e.clientY - p.y, e.clientX - p.x);
    });

    // Funções Globais (para os botões)
    window.iniciarTreino = () => { 
        rodando = true; 
        document.getElementById('menu').style.display = 'none'; 
    };

    window.criarSala = () => {
        salaId = Math.floor(100000 + Math.random() * 900000).toString();
        meuId = "p1";
        set(ref(db, 'salas/' + salaId), { 
            p1: {x: 300, y: 300, a: 0, v: true}, 
            status: 'esperando' 
        });
        document.getElementById('msg').innerText = "CÓDIGO: " + salaId;
        conectar();
    };

    window.entrarSala = () => {
        const codigo = document.getElementById('inputCodigo').value;
        if(codigo.length === 6) {
            salaId = codigo;
            meuId = "p2";
            update(ref(db, 'salas/' + salaId), { 
                p2: {x: 600, y: 300, a: 0, v: true}, 
                status: 'jogando' 
            });
            conectar();
        }
    };

    function conectar() {
        onValue(ref(db, 'salas/' + salaId), (snap) => {
            const data = snap.val();
            if(!data) return;
            if(data.status === 'jogando') {
                rodando = true;
                document.getElementById('menu').style.display = 'none';
            }
            // Sincroniza Inimigo
            let outro = (meuId === "p1") ? data.p2 : data.p1;
            if(outro) {
                inimigo.x = outro.x;
                inimigo.y = outro.y;
                inimigo.ang = outro.a;
                inimigo.vivo = outro.v;
            }
            // Verifica sua morte
            let eu = (meuId === "p1") ? data.p1 : data.p2;
            if(eu && eu.v === false && p.vivo) morrer();
        });
    }

    function morrer() {
        p.vivo = false;
        setTimeout(() => {
            p.x = Math.random() * (canvas.width - 100) + 50;
            p.y = Math.random() * (canvas.height - 100) + 50;
            p.vivo = true;
            enviarDados();
        }, 1500); // 1.5s para renascer
    }

    function enviarDados() {
        if(salaId && rodando) {
            update(ref(db, `salas/${salaId}/${meuId}`), { 
                x: p.x, y: p.y, a: p.ang, v: p.vivo 
            });
        }
    }

    // Mecânica de Tiro
    window.addEventListener('mousedown', () => {
        if(!rodando || !p.vivo || Date.now() < p.reload) return;
        p.reload = Date.now() + 500; // Delay 0.5s

        const alcance = 2000;
        const tx = p.x + Math.cos(p.ang) * alcance;
        const ty = p.y + Math.sin(p.ang) * alcance;
        
        // Ativa o rastro visual
        rastro = { x1: p.x, y1: p.y, x2: tx, y2: ty, alpha: 1 };

        // Lógica de colisão (hitscan)
        if(inimigo.vivo && salaId) {
            const dist = Math.abs((ty-p.y)*inimigo.x - (tx-p.x)*inimigo.y + tx*p.y - ty*p.x) / Math.sqrt((ty-p.y)**2 + (tx-p.x)**2);
            if(dist < 25) { // Raio de colisão
                const alvoId = (meuId === "p1") ? "p2" : "p1";
                update(ref(db, `salas/${salaId}/${alvoId}`), { v: false });
            }
        }
    });

    function desenharBoneco(x, y, ang, cor) {
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(ang);
        // Arma (Palito)
        ctx.fillStyle = "#fff";
        ctx.fillRect(15, -3, 30, 6);
        ctx.restore();
        // Corpo (Bolinha)
        ctx.beginPath();
        ctx.arc(x, y, 20, 0, Math.PI*2);
        ctx.fillStyle = cor;
        ctx.fill();
        ctx.strokeStyle = "white";
        ctx.lineWidth = 2;
        ctx.stroke();
    }

    function gameLoop() {
        if(rodando && p.vivo) {
            if(teclas['w']) p.y -= 5;
            if(teclas['s']) p.y += 5;
            if(teclas['a']) p.x -= 5;
            if(teclas['d']) p.x += 5;
            enviarDados();
        }

        // Fundo
        ctx.fillStyle = "#1a1a1a";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Desenha Rastro
        if(rastro && rastro.alpha > 0) {
            ctx.strokeStyle = `rgba(255, 255, 255, ${rastro.alpha})`;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(rastro.x1, rastro.y1);
            ctx.lineTo(rastro.x2, rastro.y2);
            ctx.stroke();
            rastro.alpha -= 0.05;
        }

        if(inimigo.vivo) desenharBoneco(inimigo.x, inimigo.y, inimigo.ang, "red");
        if(p.vivo) desenharBoneco(p.x, p.y, p.ang, p.cor);

        requestAnimationFrame(gameLoop);
    }

    gameLoop();
</script>
</body>
</html>
