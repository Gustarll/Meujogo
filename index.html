<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAME SHOT - TESTE V3</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; }
        #menu { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: white; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px; z-index: 100; }
        canvas { display: block; background: #111; }
        button { padding: 10px 20px; font-size: 18px; cursor: pointer; background: #27ae60; color: white; border: none; margin: 5px; }
        input { padding: 10px; width: 150px; text-align: center; }
    </style>
</head>
<body>

<div id="menu">
    <h1>GAME SHOT</h1>
    <button onclick="iniciarTreino()">MODO TREINAMENTO</button>
    <div style="margin: 20px 0;">
        <p>MODO ONLINE</p>
        <button onclick="criarSala()" style="background: #2980b9;">CRIAR CÓDIGO</button><br>
        <input type="text" id="inputCodigo" placeholder="000000">
        <button onclick="entrarSala()" style="background: #c0392b;">ENTRAR</button>
    </div>
    <p id="msg"></p>
</div>

<canvas id="jogo"></canvas>

<script type="module">
    // Importando apenas o necessário do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDqYWTRKvmyjRM-to5raljV464Zvott4eM",
        authDomain: "whitermultiplayer.firebaseapp.com",
        databaseURL: "https://whitermultiplayer-default-rtdb.firebaseio.com",
        projectId: "whitermultiplayer",
        appId: "1:859405698218:web:44b4d4e1a96c937373cd3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const canvas = document.getElementById('jogo');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // Configurações do Player
    let p = { x: 200, y: 200, angulo: 0, cor: '#00f', lastShot: 0 };
    let inimigo = { x: -100, y: -100, angulo: 0, cor: '#f00' };
    let teclas = {};
    let rodando = false;
    let meuId = ""; 
    let salaId = "";

    // Captura de Teclado (WASD)
    window.onkeydown = (e) => teclas[e.key.toLowerCase()] = true;
    window.onkeyup = (e) => teclas[e.key.toLowerCase()] = false;

    // Funções de Sala
    window.iniciarTreino = () => {
        document.getElementById('menu').style.display = 'none';
        rodando = true;
    };

    window.criarSala = () => {
        salaId = Math.floor(100000 + Math.random() * 900000).toString();
        meuId = "p1";
        set(ref(db, 'salas/' + salaId), { p1: {x:200, y:200, a:0}, status: 'esperando' });
        document.getElementById('msg').innerText = "CÓDIGO: " + salaId;
        conectarFirebase();
    };

    window.entrarSala = () => {
        salaId = document.getElementById('inputCodigo').value;
        if(salaId.length === 6) {
            meuId = "p2";
            update(ref(db, 'salas/' + salaId), { p2: {x:600, y:200, a:0}, status: 'jogando' });
            conectarFirebase();
        }
    };

    function conectarFirebase() {
        onValue(ref(db, 'salas/' + salaId), (snap) => {
            const dados = snap.val();
            if(!dados) return;
            if(dados.status === 'jogando') {
                document.getElementById('menu').style.display = 'none';
                rodando = true;
            }
            if(meuId === "p1" && dados.p2) inimigo = { x: dados.p2.x, y: dados.p2.y, angulo: dados.p2.a };
            if(meuId === "p2" && dados.p1) inimigo = { x: dados.p1.x, y: dados.p1.y, angulo: dados.p1.a };
        });
    }

    // Tiro
    window.onmousedown = () => {
        if(!rodando) return;
        const agora = Date.now();
        if(agora - p.lastShot > 500) { // Delay 0.5s
            p.lastShot = agora;
            // Efeito de flash do tiro
            ctx.beginPath();
            ctx.strokeStyle = "white";
            ctx.lineWidth = 2;
            ctx.moveTo(p.x, p.y);
            ctx.lineTo(p.x + Math.cos(p.angulo)*1000, p.y + Math.sin(p.angulo)*1000);
            ctx.stroke();
        }
    };

    function loop() {
        if(rodando) {
            // Movimentação WASD
            if(teclas['w']) p.y -= 5;
            if(teclas['s']) p.y += 5;
            if(teclas['a']) p.x -= 5;
            if(teclas['d']) p.x += 5;

            // Mira
            window.onmousemove = (e) => {
                p.angulo = Math.atan2(e.clientY - p.y, e.clientX - p.x);
            };

            // Enviar posição
            if(salaId) {
                update(ref(db, `salas/${salaId}/${meuId}`), { x: p.x, y: p.y, a: p.angulo });
            }

            // Desenhar
            ctx.fillStyle = "#111";
            ctx.fillRect(0,0,canvas.width, canvas.height);

            // Desenha Inimigo
            desenharBoneco(inimigo.x, inimigo.y, inimigo.angulo, "red");
            // Desenha Você
            desenharBoneco(p.x, p.y, p.angulo, "cyan");
        }
        requestAnimationFrame(loop);
    }

    function desenharBoneco(x, y, ang, cor) {
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(ang);
        // O Palito (Arma)
        ctx.fillStyle = "#fff";
        ctx.fillRect(15, -3, 30, 6);
        // A Bolinha (Corpo)
        ctx.restore();
        ctx.beginPath();
        ctx.arc(x, y, 20, 0, Math.PI*2);
        ctx.fillStyle = cor;
        ctx.fill();
    }

    loop();
</script>
</body>
</html>
